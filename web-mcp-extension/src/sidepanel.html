<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MCP Portal Assistant</title>
    <style>
      /* â”€â”€ Reset & Variables (charte Orange) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

      :root {
        --bg:            #1a1a1a;
        --surface:       #242424;
        --surface-alt:   #2d2d2d;
        --border:        #3a3a3a;
        --primary:       #ff7900;
        --primary-hover: #f16e00;
        --primary-dim:   rgba(255,121,0,0.12);
        --primary-dim2:  rgba(255,121,0,0.25);
        --user-bg:       #ff7900;
        --user-text:     #1a1a1a;
        --assistant-bg:  #2d2d2d;
        --error-bg:      #3b1212;
        --error-border:  #7f1d1d;
        --success:       #4caf50;
        --warning:       #ff9800;
        --text:          #f5f5f5;
        --text-muted:    #8c8c8c;
        --radius:        12px;
        --font:          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      }

      html, body {
        height: 100%;
        font-family: var(--font);
        background: var(--bg);
        color: var(--text);
        font-size: 14px;
      }

      /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .app {
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
      }

      /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      header {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 11px 14px;
        background: var(--surface);
        border-bottom: 2px solid var(--primary);
        flex-shrink: 0;
      }

      header .logo {
        width: 30px;
        height: 30px;
        background: var(--primary);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
      }

      header h1 {
        font-size: 14px;
        font-weight: 700;
        flex: 1;
      }

      #model-badge {
        font-size: 10px;
        font-family: monospace;
        color: var(--primary);
        background: var(--primary-dim);
        border: 1px solid rgba(255,121,0,0.35);
        border-radius: 6px;
        padding: 2px 7px;
        max-width: 130px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        flex-shrink: 0;
      }

      header a.settings-link {
        color: var(--text-muted);
        font-size: 17px;
        text-decoration: none;
        cursor: pointer;
        line-height: 1;
        transition: color 0.15s;
        flex-shrink: 0;
      }
      header a.settings-link:hover { color: var(--primary); }

      /* â”€â”€ Tools Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .tools-panel {
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        padding: 0;
        flex-shrink: 0;
        overflow: hidden;
        transition: max-height 0.25s ease;
        max-height: 200px;
      }

      .tools-panel.collapsed { max-height: 0; }

      .tools-panel-inner { padding: 8px 14px 12px; }

      /* Barre de titre du panneau outils */
      .tools-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 6px 14px;
        background: var(--surface);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }

      .tools-panel-header .tools-label {
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tools-count-badge {
        background: var(--primary-dim);
        color: var(--primary);
        border: 1px solid rgba(255,121,0,0.3);
        border-radius: 10px;
        font-size: 10px;
        font-weight: 700;
        padding: 1px 6px;
        display: none;
      }
      .tools-count-badge.visible { display: inline; }

      #toggle-tools-btn,
      #toggle-resources-btn,
      #toggle-prompts-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: background 0.12s, color 0.12s;
      }
      #toggle-tools-btn:hover,
      #toggle-resources-btn:hover,
      #toggle-prompts-btn:hover { background: var(--primary-dim); color: var(--primary); }

      #toggle-tools-btn .toggle-icon,
      #toggle-resources-btn .toggle-icon,
      #toggle-prompts-btn .toggle-icon {
        display: inline-block;
        font-size: 9px;
        transition: transform 0.25s;
      }
      #toggle-tools-btn.collapsed .toggle-icon,
      #toggle-resources-btn.collapsed .toggle-icon,
      #toggle-prompts-btn.collapsed .toggle-icon { transform: rotate(-90deg); }

      #tools-list {
        list-style: none;
        display: flex;
        flex-direction: column;
        gap: 4px;
        max-height: 130px;
        overflow-y: auto;
      }

      .tool-item {
        background: var(--surface-alt);
        border: 1px solid var(--border);
        border-left: 3px solid var(--primary);
        border-radius: 8px;
        padding: 6px 10px;
      }

      .tool-name {
        font-weight: 700;
        font-size: 12px;
        color: var(--primary);
        display: block;
        font-family: monospace;
      }

      .tool-desc {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      #no-tools-msg {
        font-size: 12px;
        color: var(--text-muted);
        text-align: center;
        padding: 4px 0;
      }

      /* â”€â”€ Status Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .status-bar {
        font-size: 11px;
        padding: 4px 14px;
        background: var(--bg);
        border-bottom: 1px solid var(--border);
        color: var(--text-muted);
        flex-shrink: 0;
      }
      .status-bar.ready   { color: var(--success); }
      .status-bar.working { color: var(--warning); animation: pulse-text 1.5s infinite; }
      .status-bar.error   { color: #ef5350; }

      @keyframes pulse-text {
        0%, 100% { opacity: 1; }
        50%       { opacity: 0.5; }
      }

      /* â”€â”€ Chat Window â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      #chat-container {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        scroll-behavior: smooth;
      }

      .message {
        display: flex;
        flex-direction: column;
        max-width: 90%;
      }

      .message.user { align-self: flex-end; align-items: flex-end; }
      .message.assistant { align-self: flex-start; align-items: flex-start; }
      .message.error { align-self: flex-start; align-items: flex-start; }

      .bubble {
        padding: 10px 14px;
        border-radius: 16px;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        font-size: 13px;
      }

      .message.user .bubble {
        background: var(--user-bg);
        color: #1a1a1a;
        font-weight: 500;
        border-bottom-right-radius: 4px;
      }

      .message.assistant .bubble {
        background: var(--assistant-bg);
        border: 1px solid var(--border);
        border-bottom-left-radius: 4px;
      }

      .message.error .bubble {
        background: var(--error-bg);
        border: 1px solid var(--error-border);
        border-bottom-left-radius: 4px;
        color: #fca5a5;
      }

      /* â”€â”€ Rendu Markdown dans les bulles assistant â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .bubble.markdown { white-space: normal; }

      .bubble.markdown > *:first-child { margin-top: 0; }
      .bubble.markdown > *:last-child  { margin-bottom: 0; }

      .bubble.markdown p   { margin: 0 0 8px; }
      .bubble.markdown ul,
      .bubble.markdown ol  { margin: 0 0 8px 18px; padding: 0; }
      .bubble.markdown li  { margin-bottom: 3px; }

      .bubble.markdown h1,
      .bubble.markdown h2,
      .bubble.markdown h3,
      .bubble.markdown h4 {
        margin: 10px 0 5px;
        font-weight: 700;
        color: var(--primary);
        line-height: 1.3;
      }
      .bubble.markdown h1 { font-size: 15px; }
      .bubble.markdown h2 { font-size: 14px; }
      .bubble.markdown h3 { font-size: 13px; }
      .bubble.markdown h4 { font-size: 12px; }

      .bubble.markdown code {
        background: rgba(255,121,0,0.12);
        border: 1px solid rgba(255,121,0,0.22);
        border-radius: 4px;
        padding: 1px 5px;
        font-family: 'Cascadia Code', 'Fira Mono', monospace;
        font-size: 11.5px;
        color: #ffad66;
      }

      .bubble.markdown pre {
        background: #111;
        border: 1px solid var(--border);
        border-left: 3px solid var(--primary);
        border-radius: 8px;
        padding: 10px 12px;
        margin: 6px 0 8px;
        overflow-x: auto;
      }
      .bubble.markdown pre code {
        background: none;
        border: none;
        padding: 0;
        color: #e5e5e5;
        font-size: 11.5px;
      }

      .bubble.markdown blockquote {
        border-left: 3px solid var(--primary);
        background: rgba(255,121,0,0.06);
        padding: 6px 12px;
        margin: 6px 0;
        border-radius: 0 6px 6px 0;
        color: var(--text-muted);
        font-style: italic;
      }

      .bubble.markdown table {
        border-collapse: collapse;
        width: 100%;
        margin: 6px 0 8px;
        font-size: 12px;
      }
      .bubble.markdown th,
      .bubble.markdown td {
        border: 1px solid var(--border);
        padding: 4px 8px;
        text-align: left;
      }
      .bubble.markdown th {
        background: var(--surface-alt);
        color: var(--primary);
        font-weight: 700;
      }
      .bubble.markdown tr:nth-child(even) td { background: rgba(255,255,255,0.02); }

      .bubble.markdown a {
        color: var(--primary);
        text-decoration: underline;
        text-underline-offset: 2px;
      }
      .bubble.markdown a:hover { color: var(--primary-hover); }

      .bubble.markdown hr {
        border: none;
        border-top: 1px solid var(--border);
        margin: 8px 0;
      }

      .bubble.markdown strong { font-weight: 700; }
      .bubble.markdown em    { font-style: italic; color: var(--text-muted); }

      /* Typing indicator */
      .typing {
        display: flex;
        gap: 4px;
        align-items: center;
        padding: 12px 14px;
      }

      .typing span {
        width: 7px;
        height: 7px;
        background: var(--primary);
        border-radius: 50%;
        animation: bounce 1.2s infinite;
        opacity: 0.8;
      }
      .typing span:nth-child(2) { animation-delay: 0.2s; }
      .typing span:nth-child(3) { animation-delay: 0.4s; }

      @keyframes bounce {
        0%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-6px); }
      }

      /* â”€â”€ ChaÃ®ne de pensÃ©es (Thinking) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .message.thinking {
        align-self: flex-start;
        align-items: flex-start;
        max-width: 95%;
      }

      .thought-block {
        background: rgba(168,85,247,0.07);
        border: 1px solid rgba(168,85,247,0.22);
        border-left: 3px solid #a855f7;
        border-radius: 14px;
        overflow: hidden;
        font-size: 12px;
        width: 100%;
      }

      .thought-block summary {
        padding: 7px 12px;
        font-size: 11px;
        font-weight: 600;
        color: #c084fc;
        cursor: pointer;
        list-style: none;
        display: flex;
        align-items: center;
        gap: 6px;
        user-select: none;
        letter-spacing: 0.03em;
      }
      .thought-block summary::-webkit-details-marker { display: none; }
      .thought-block summary::before {
        content: 'â–¶';
        font-size: 8px;
        transition: transform 0.2s;
        display: inline-block;
        flex-shrink: 0;
      }
      .thought-block[open] summary::before { transform: rotate(90deg); }
      .thought-block[open] summary {
        border-bottom: 1px solid rgba(168,85,247,0.18);
      }

      .thought-content {
        padding: 10px 13px;
        color: var(--text-muted);
        font-size: 11px;
        line-height: 1.65;
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 220px;
        overflow-y: auto;
        font-style: italic;
      }

      /* â”€â”€ Input area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      .input-area {
        display: flex;
        align-items: flex-end;
        gap: 8px;
        padding: 12px 16px;
        background: var(--surface);
        border-top: 1px solid var(--border);
        flex-shrink: 0;
      }

      #user-input {
        flex: 1;
        background: var(--surface-alt);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 12px;
        color: var(--text);
        font-family: var(--font);
        font-size: 13px;
        resize: none;
        line-height: 1.4;
        min-height: 40px;
        max-height: 120px;
        overflow-y: auto;
        outline: none;
        transition: border-color 0.15s, box-shadow 0.15s;
      }

      #user-input:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(255,121,0,0.2);
      }

      #user-input::placeholder { color: var(--text-muted); }

      #send-btn {
        background: var(--primary);
        border: none;
        border-radius: 10px;
        color: #1a1a1a;
        font-size: 17px;
        font-weight: 700;
        width: 40px;
        height: 40px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.15s, opacity 0.15s, transform 0.1s;
        flex-shrink: 0;
      }

      #send-btn:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: scale(1.05);
      }

      #send-btn:active:not(:disabled) { transform: scale(0.96); }

      #send-btn:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }

      /* â”€â”€ Scrollbars â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(255,121,0,0.3); }
    </style>
  </head>
  <body>
    <div class="app">

      <!-- En-tÃªte -->
      <header>
        <div class="logo">ğŸ¤–</div>
        <h1>MCP Assistant</h1>
        <span id="model-badge">gemini-2.0-flash</span>
        <a class="settings-link" href="options.html" target="_blank" title="ParamÃ¨tres">âš™ï¸</a>
      </header>

      <!-- Barre de titre du panneau outils (toujours visible) -->
      <div class="tools-panel-header">
        <span class="tools-label">
          ğŸ”§ Outils dÃ©tectÃ©s
          <span id="tools-count-badge" class="tools-count-badge">0</span>
        </span>
        <button id="toggle-tools-btn" aria-expanded="true" aria-controls="tools-panel">
          <span class="toggle-icon">â–¼</span>
          <span id="toggle-tools-label">Masquer</span>
        </button>
      </div>

      <!-- Panneau des outils (collapsible) -->
      <section id="tools-panel" class="tools-panel" aria-label="Outils dÃ©tectÃ©s">
        <div class="tools-panel-inner">
          <ul id="tools-list"></ul>
          <p id="no-tools-msg">Aucun outil dÃ©tectÃ© â€” naviguez vers un portail compatible.</p>
        </div>
      </section>

      <!-- Barre titre â€” Resources -->
      <div class="tools-panel-header">
        <span class="tools-label">
          ğŸ“¦ Ressources dÃ©tectÃ©es
          <span id="resources-count-badge" class="tools-count-badge">0</span>
        </span>
        <button id="toggle-resources-btn" class="collapsed" aria-expanded="false" aria-controls="resources-panel">
          <span class="toggle-icon">â–¼</span>
          <span class="toggle-label">Afficher</span>
        </button>
      </div>

      <!-- Panneau des ressources (collapsible) -->
      <section id="resources-panel" class="tools-panel collapsed" aria-label="Ressources dÃ©tectÃ©es">
        <div class="tools-panel-inner">
          <ul id="resources-list"></ul>
          <p id="no-resources-msg">Aucune ressource dÃ©tectÃ©e.</p>
        </div>
      </section>

      <!-- Barre titre â€” Prompts -->
      <div class="tools-panel-header">
        <span class="tools-label">
          ğŸ’¬ Prompts dÃ©tectÃ©s
          <span id="prompts-count-badge" class="tools-count-badge">0</span>
        </span>
        <button id="toggle-prompts-btn" class="collapsed" aria-expanded="false" aria-controls="prompts-panel">
          <span class="toggle-icon">â–¼</span>
          <span class="toggle-label">Afficher</span>
        </button>
      </div>

      <!-- Panneau des prompts (collapsible) -->
      <section id="prompts-panel" class="tools-panel collapsed" aria-label="Prompts dÃ©tectÃ©s">
        <div class="tools-panel-inner">
          <ul id="prompts-list"></ul>
          <p id="no-prompts-msg">Aucun prompt dÃ©tectÃ©.</p>
        </div>
      </section>

      <!-- Barre de statut -->
      <div id="status-bar" class="status-bar" role="status">
        En attente de la dÃ©tection d'outils sur la pageâ€¦
      </div>

      <!-- FenÃªtre de chat -->
      <main id="chat-container" aria-live="polite">
        <div class="message assistant">
          <div class="bubble">
            ğŸ‘‹ Bonjour ! Je suis votre assistant MCP.<br>
            Une fois les outils du portail dÃ©tectÃ©s, vous pourrez me poser vos questions.
          </div>
        </div>
      </main>

      <!-- Zone de saisie -->
      <div class="input-area">
        <textarea
          id="user-input"
          rows="1"
          placeholder="Posez votre questionâ€¦ (EntrÃ©e pour envoyer)"
          aria-label="Message"
        ></textarea>
        <button id="send-btn" disabled aria-label="Envoyer">â¤</button>
      </div>
    </div>

    <!-- Le bundle gÃ©nÃ©rÃ© par esbuild (npm run build) -->
    <script src="sidepanel.js" type="module"></script>
  </body>
</html>
